<ng-container *tpLoadingState="loadingState">
  <tp-page-frame [title]="'Portal.Administration.Title' | translate" [backLink]="'..'" [navigationTabs]="pages">
    <ng-template #buttons>
      <tp-action-button
        [title]="'Portal.Administration.NewUser'"
        [type]="'outline-success'"
        [icon]="'plus-circle'"
        [routerLink]="'create/user'" />
    </ng-template>
    <ng-template #mainContent>
      <div class="card">
        <div class="card-header d-flex flex-row align-items-center">
          <tp-badge context="Administration" label="UserCount" [value]="users.length" />
        </div>
        <div class="card-body p-0">
          <table class="table" [attr.aria-label]="'Portal.Administration.Users.TableLabel' | translate">
            <thead>
              <tr>
                <th translate="Portal.Administration.Users.Id"></th>
                <th translate="Portal.Administration.Users.Name"></th>
                <th translate="Portal.Administration.Users.EMail"></th>
                <th translate="Portal.Administration.Users.CreatedAt"></th>
                <th translate="Portal.Administration.Users.LastPasswordChange"></th>
                <th translate="Portal.Administration.Users.Administrator"></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (user of users; track user) {
                @let isCurrentUser = user.id === currentUserId;
                <tr>
                  <td class="align-middle small text-secondary">{{ user.id }}</td>
                  <td class="align-middle">{{ user.name }}</td>
                  <td class="align-middle">{{ user.eMail }}</td>
                  <td class="align-middle small">{{ user.createdAt | translateDate: 'medium' }}</td>
                  <td class="align-middle small">{{ user.lastPasswordChange | translateDate: 'medium' }}</td>
                  <td class="align-middle text-center">
                    @if (user.isAdministrator) {
                      <i class="bi bi-check-circle"></i>
                    }
                  </td>
                  <td>
                    <div class="d-flex flex-row gap-2" [ngClass]="{ 'tp-cursor-not-allowed': isCurrentUser }">
                      <tp-action-button
                        [icon]="'pencil'"
                        [type]="'outline-secondary'"
                        [mode]="'IconOnly'"
                        [disabled]="isCurrentUser"
                        (buttonClick)="editButtonClicked(user.id, editUserCanvas)" />
                      <tp-action-button
                        [icon]="'trash'"
                        [type]="'outline-danger'"
                        [mode]="'IconOnly'"
                        [disabled]="isCurrentUser"
                        (buttonClick)="deleteButtonClicked(user.id, deleteConfirmationCanvas)" />
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </ng-template>
  </tp-page-frame>
</ng-container>

<ng-template #editUserCanvas>
  <div class="p-3">
    @if (userSelectedForEditing) {
      <div class="fw-bold mb-3" translate="Portal.Administration.EditUser.Title"></div>
      <div class="mb-4" translate="Portal.Administration.EditUser.Info"></div>

      <!-- TODO: Add validation feedback -->

      <form [formGroup]="editUserForm">
        <div class="form-group mb-3">
          <label class="form-label" for="userName" translate="Portal.Administration.EditUser.Name"></label>
          <input class="form-control" id="userName" type="text" formControlName="userName" />
        </div>

        <div class="form-group mb-3">
          <label class="form-label" for="eMail" translate="Portal.Administration.EditUser.Email"></label>
          <input class="form-control" id="eMail" type="email" formControlName="eMail" />
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" id="isAdministrator" type="checkbox" formControlName="isAdministrator" />
          <label class="form-check-label" for="isAdministrator" translate="Portal.Administration.EditUser.IsAdministrator"></label>
        </div>

        @let isAdministratorControl = editUserForm.get('isAdministrator')!;
        @if (!userSelectedForEditing.isAdministrator && isAdministratorControl.value) {
          <tp-alert
            [margin]="'mb-3'"
            [type]="'warning'"
            [icon]="'exclamation-triangle'"
            [text]="'Portal.Administration.EditUser.AdministratorWarning'" />
        }

        <div class="form-check mb-3">
          <input
            class="form-check-input"
            id="updatePassword"
            type="checkbox"
            formControlName="updatePassword"
            (change)="updatePasswordToggled()" />
          <label class="form-check-label" for="updatePassword" translate="Portal.Administration.EditUser.UpdatePassword"></label>
        </div>

        @let updatePasswordControl = editUserForm.get('updatePassword')!;
        @if (updatePasswordControl.value) {
          <div class="form-group mb-3">
            <label class="form-label" for="password" translate="Portal.Administration.EditUser.Password"></label>
            <input class="form-control" id="password" type="password" formControlName="password" />
          </div>
        }
      </form>

      <div class="mt-4 d-flex flex-row">
        <tp-action-button
          [type]="'outline-success'"
          [icon]="'floppy'"
          [title]="'Portal.General.Save'"
          (buttonClick)="editConfirmed(userSelectedForEditing.id)" />
      </div>
    }
  </div>
</ng-template>

<ng-template #deleteConfirmationCanvas>
  <div class="p-3">
    @if (userSelectedForDeletion) {
      <tp-delete-widget
        [translationKey]="'Portal.Administration.DeleteUser'"
        [thinLayout]="true"
        [targetObjectName]="userSelectedForDeletion.name"
        (deleteClick)="deleteConfirmed(userSelectedForDeletion.id)" />
      <div class="mt-3 small text-secondary">
        <span translate="Portal.Administration.DeleteUser.IdConfirmation"></span><br />
        <span>{{ userSelectedForDeletion.id }}</span>
      </div>
    }
  </div>
</ng-template>
