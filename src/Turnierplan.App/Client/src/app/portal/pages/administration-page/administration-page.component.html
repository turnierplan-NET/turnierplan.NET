<ng-container *tpLoadingState="loadingState">
  <tp-page-frame [title]="'Portal.Administration.Title' | translate" [backLink]="'..'" [navigationTabs]="pages">
    <ng-template #buttons>
      <tp-action-button
        [title]="'Portal.Administration.NewUser'"
        [type]="'outline-success'"
        [icon]="'plus-circle'"
        [routerLink]="'create/user'" />
    </ng-template>
    <ng-template #mainContent>
      <div class="card">
        <div class="card-header d-flex flex-row align-items-center">
          <tp-badge context="Administration" label="UserCount" [value]="users.length" />
        </div>
        <div class="card-body p-0">
          <table class="table" [attr.aria-label]="'Portal.Administration.Users.TableLabel' | translate">
            <thead>
              <tr>
                <th translate="Portal.Administration.Users.UserName"></th>
                <th translate="Portal.Administration.Users.FullName"></th>
                <th translate="Portal.Administration.Users.EMail"></th>
                <th translate="Portal.Administration.Users.CreatedAt"></th>
                <th translate="Portal.Administration.Users.LastPasswordChange"></th>
                <th translate="Portal.Administration.Users.Administrator"></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (user of users; track user) {
                @let isCurrentUser = user.id === currentUserId;
                <tr>
                  <td class="align-middle">{{ user.userName }}</td>
                  <td class="align-middle">{{ user.fullName ?? '' }}</td>
                  <td class="align-middle">{{ user.eMail ?? '' }}</td>
                  <td class="align-middle small">{{ user.createdAt | translateDate: 'medium' }}</td>
                  <td class="align-middle small">{{ user.lastPasswordChange | translateDate: 'medium' }}</td>
                  <td class="align-middle">
                    @if (user.isAdministrator) {
                      <i class="bi bi-check-circle"></i>
                    }
                  </td>
                  <td>
                    <div class="d-flex flex-row gap-2">
                      <tp-action-button
                        [icon]="'pencil'"
                        [type]="'outline-secondary'"
                        [mode]="'IconOnly'"
                        (buttonClick)="editButtonClicked(user.id, editUserCanvas)" />
                      <div [ngClass]="{ 'tp-cursor-not-allowed': isCurrentUser }">
                        <tp-action-button
                          [icon]="'trash'"
                          [type]="'outline-danger'"
                          [mode]="'IconOnly'"
                          [disabled]="isCurrentUser"
                          (buttonClick)="deleteButtonClicked(user.id, deleteConfirmationCanvas)" />
                      </div>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </ng-template>
  </tp-page-frame>
</ng-container>

<ng-template #editUserCanvas>
  <div class="p-3">
    <div class="mb-3">
      <tp-action-button
        [title]="'Portal.General.Cancel'"
        [icon]="'x-circle'"
        [type]="'outline-secondary'"
        (buttonClick)="currentOffcanvas?.close()" />
    </div>
    @if (userSelectedForEditing) {
      <div class="fw-bold mb-3" translate="Portal.Administration.EditUser.Title"></div>
      <div class="mb-4" translate="Portal.Administration.EditUser.Info"></div>

      <form [formGroup]="editUserForm">
        <div class="form-group mb-3">
          @let userNameControl = editUserForm.get('userName')!;
          <label class="form-label" for="userName" translate="Portal.Administration.EditUser.UserName"></label>
          <input
            class="form-control"
            id="userName"
            type="text"
            formControlName="userName"
            [ngClass]="userNameControl.dirty ? (userNameControl.invalid ? 'is-invalid' : 'is-valid') : ''" />
          <div class="invalid-feedback" translate="Portal.Administration.EditUser.UserNameInvalid"></div>
        </div>

        <div class="form-group mb-3">
          @let fullNameControl = editUserForm.get('fullName')!;
          <label class="form-label" for="fullName" translate="Portal.Administration.EditUser.FullName"></label>
          <input
            class="form-control"
            id="fullName"
            type="text"
            formControlName="fullName"
            [ngClass]="fullNameControl.dirty ? (fullNameControl.invalid ? 'is-invalid' : 'is-valid') : ''" />
          <div class="invalid-feedback" translate="Portal.Administration.EditUser.FullNameInvalid"></div>
        </div>

        <div class="form-group mb-3">
          @let eMailNameControl = editUserForm.get('eMail')!;
          <label class="form-label" for="eMail" translate="Portal.Administration.EditUser.Email"></label>
          <input
            class="form-control"
            id="eMail"
            type="email"
            formControlName="eMail"
            [ngClass]="eMailNameControl.dirty ? (eMailNameControl.invalid ? 'is-invalid' : 'is-valid') : ''" />
          <div class="invalid-feedback" translate="Portal.Administration.EditUser.EmailInvalid"></div>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" id="isAdministrator" type="checkbox" formControlName="isAdministrator" />
          <label class="form-check-label" for="isAdministrator" translate="Portal.Administration.EditUser.IsAdministrator"></label>
        </div>

        @let isAdministratorControl = editUserForm.get('isAdministrator')!;
        @if (!userSelectedForEditing.isAdministrator && isAdministratorControl.value) {
          <tp-alert
            [margin]="'mb-3'"
            [type]="'warning'"
            [icon]="'exclamation-triangle'"
            [text]="'Portal.Administration.EditUser.AdministratorWarning'" />
        }

        <div class="form-check mb-3">
          <input
            class="form-check-input"
            id="updatePassword"
            type="checkbox"
            formControlName="updatePassword"
            (change)="updatePasswordToggled()" />
          <label class="form-check-label" for="updatePassword" translate="Portal.Administration.EditUser.UpdatePassword"></label>
        </div>

        @let updatePasswordControl = editUserForm.get('updatePassword')!;
        @if (updatePasswordControl.value) {
          <div class="form-group mb-3">
            @let passwordControl = editUserForm.get('password')!;
            <label class="form-label" for="password" translate="Portal.Administration.EditUser.Password"></label>
            <input
              class="form-control"
              id="password"
              type="password"
              formControlName="password"
              [ngClass]="passwordControl.dirty ? (passwordControl.invalid ? 'is-invalid' : 'is-valid') : ''" />
            <div class="invalid-feedback" translate="Portal.Administration.EditUser.PasswordInvalid"></div>
          </div>
        }
      </form>

      <div class="mt-4 d-flex flex-row">
        <tp-action-button
          [type]="'outline-success'"
          [icon]="'floppy'"
          [title]="'Portal.General.Save'"
          [disabled]="editUserForm.invalid"
          (buttonClick)="editConfirmed(userSelectedForEditing.id)" />
      </div>
    }
  </div>
</ng-template>

<ng-template #deleteConfirmationCanvas>
  <div class="p-3">
    <div class="mb-3">
      <tp-action-button
        [title]="'Portal.General.Cancel'"
        [icon]="'x-circle'"
        [type]="'outline-secondary'"
        (buttonClick)="currentOffcanvas?.close()" />
    </div>
    @if (userSelectedForDeletion) {
      <tp-delete-widget
        [translationKey]="'Portal.Administration.DeleteUser'"
        [thinLayout]="true"
        [targetObjectName]="userSelectedForDeletion.userName"
        (deleteClick)="deleteConfirmed(userSelectedForDeletion.id)" />
      <div class="mt-3 small text-secondary">
        <span translate="Portal.Administration.DeleteUser.IdConfirmation"></span><br />
        <span>{{ userSelectedForDeletion.id }}</span>
      </div>
    }
  </div>
</ng-template>
