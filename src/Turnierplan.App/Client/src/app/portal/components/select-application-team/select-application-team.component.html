<div class="mb-2" translate="Portal.SelectApplicationTeam.Explanation" id="selectApplicationTeamExplanation"></div>

@if (isLoadingPlanningRealms) {
  <div class="d-flex flex-row gap-2">
    <tp-small-spinner />
    <span translate="Portal.SelectApplicationTeam.LoadingPlanningRealms"></span>
  </div>
} @else if (planningRealms) {
  @if (planningRealms.length === 0) {
    <div class="text-secondary fst-italic" translate="Portal.SelectApplicationTeam.NoPlanningRealms"></div>
  } @else {
    <select
      class="form-select"
      aria-labelledby="selectApplicationTeamExplanation"
      [(ngModel)]="currentPlanningRealmId"
      (ngModelChange)="onPlanningRealmChange($event)">
      @for (planningRealm of planningRealms; track planningRealm) {
        <option [value]="planningRealm.id">{{ planningRealm.name }}</option>
      }
    </select>

    @if (isLoadingPlanningRealmDetail) {
      <div class="mt-3 d-flex flex-row gap-2">
        <tp-small-spinner />
        <span translate="Portal.SelectApplicationTeam.LoadingPlanningRealmDetail"></span>
      </div>
    } @else if (planningRealmDetail) {
      <div class="mt-4">
        <span translate="Portal.SelectApplicationTeam.FilterExplanation"></span>
        <tp-tooltip-icon [tooltipText]="'Portal.SelectApplicationTeam.FilterTooltip'" />
      </div>
      <div class="mt-2 border rounded-2 p-2">
        <tp-manage-applications-filter
          [planningRealm]="planningRealmDetail"
          [filter]="applicationsFilter"
          (filterChange)="onApplicationsFilterChange($event)" />
      </div>

      @if (isLoadingApplications) {
        <div class="mt-3 d-flex flex-row gap-2">
          <tp-small-spinner />
          <span translate="Portal.SelectApplicationTeam.LoadingApplications"></span>
        </div>
      } @else if (applications) {
        @if (applications.totalItems === 0) {
          <div class="mt-3 text-secondary fst-italic" translate="Portal.SelectApplicationTeam.NoApplications"></div>
        } @else {
          <table class="my-4 table table-sm table-bordered">
            <thead>
              <tr>
                <th style="width: 1px"></th>
                <th translate="Portal.SelectApplicationTeam.TournamentClass"></th>
                <th translate="Portal.SelectApplicationTeam.TeamName"></th>
                <th translate="Portal.SelectApplicationTeam.ApplicationDetails"></th>
              </tr>
            </thead>
            <tbody>
              @for (application of applications.items; track application.id) {
                @let filteredTeams = filterTeams(application.teams);
                @for (team of filteredTeams; track team.id; let isFirst = $first) {
                  @let tournamentClass = getTournamentClassName(team.tournamentClassId);
                  <tr>
                    <td class="align-middle">
                      <!-- TODO: Disable checkbox when this team is already linked -->
                      <input
                        type="checkbox"
                        aria-label="Mannschaft '{{ team.name }}' ({{ tournamentClass }}) selektieren"
                        class="tp-cursor-pointer form-check-input mx-1"
                        [ngModel]="isTeamSelected(team.id)"
                        (ngModelChange)="setTeamSelected(team.id, $event, team.name)" />
                    </td>
                    <td class="align-middle">{{ tournamentClass }}</td>
                    <td class="align-middle text-nowrap">{{ team.name }}</td>
                    @if (isFirst) {
                      <td [attr.rowspan]="filteredTeams.length" class="align-middle small">
                        <div>{{ application.contact }}</div>
                        <div class="text-secondary">{{ application.createdAt | translateDate: 'short' }}</div>
                      </td>
                    }
                  </tr>
                }
              }
            </tbody>
          </table>
          <tp-pagination [pagination]="applications" (pageChange)="switchPage($event)" />
        }
      } @else {
        <div class="mt-3 fw-bold text-danger" translate="Portal.SelectApplicationTeam.LoadingApplicationsFailed"></div>
      }
    } @else {
      <div class="mt-3 fw-bold text-danger" translate="Portal.SelectApplicationTeam.LoadingPlanningRealmDetailFailed"></div>
    }
  }
} @else {
  <div class="fw-bold text-danger" translate="Portal.SelectApplicationTeam.LoadingPlanningRealmsFailed"></div>
}
