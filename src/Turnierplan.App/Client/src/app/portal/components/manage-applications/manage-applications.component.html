@let writeAllowed = (authorizationService.isActionAllowed$(planningRealm.id, Actions.GenericWrite) | async) ?? false;

@if (isLoading) {
  <div class="mt-4">
    <tp-loading-indicator [marginY]="false" />
  </div>
} @else if (result) {
  @if (result.totalItems === 0) {
    <div class="mt-5 fst-italic text-center" translate="Portal.ViewPlanningRealm.Applications.NoResults"></div>
  } @else {
    <table class="table table-bordered">
      <thead>
        <tr>
          <th colspan="3">
            @if (allApplicationsExpanded) {
              <i
                class="ms-2 bi bi-chevron-bar-contract tp-cursor-pointer"
                [ngbTooltip]="'Portal.ViewPlanningRealm.Applications.CollapseAllTooltip' | translate"
                (click)="setAllApplicationsExpanded(false)"></i>
            } @else {
              <i
                class="ms-2 bi bi-chevron-bar-expand tp-cursor-pointer"
                [ngbTooltip]="'Portal.ViewPlanningRealm.Applications.ExpandAllTooltip' | translate"
                (click)="setAllApplicationsExpanded(true)"></i>
            }
          </th>
          <th style="width: 1px">
            <span translate="Portal.ViewPlanningRealm.Applications.TableHeader.Tag"></span>
            <tp-tooltip-icon [tooltipText]="'Portal.ViewPlanningRealm.Applications.TableHeader.TagTooltip'" />
          </th>
          <th style="width: 1px" translate="Portal.ViewPlanningRealm.Applications.TableHeader.CreatedAt"></th>
          <th style="width: 1px" translate="Portal.ViewPlanningRealm.Applications.TableHeader.TeamCount"></th>
          <th style="width: 15%" translate="Portal.ViewPlanningRealm.Applications.TableHeader.Contact"></th>
          <th style="width: 20%">
            <span class="me-2" translate="Portal.ViewPlanningRealm.Applications.TableHeader.ContactEmail"></span>
            @if (combinedEmailAddresses && combinedEmailAddresses.length > 0) {
              <tp-copy-to-clipboard
                [tooltipOverwrite]="'Portal.ViewPlanningRealm.Applications.TableHeader.CopyAllEmailAddresses'"
                [value]="combinedEmailAddresses" />
            }
          </th>
          <th style="width: 15%" translate="Portal.ViewPlanningRealm.Applications.TableHeader.ContactTelephone"></th>
          <th style="width: 20%">
            <span translate="Portal.ViewPlanningRealm.Applications.TableHeader.Comment"></span>
            <tp-tooltip-icon [tooltipText]="'Portal.ViewPlanningRealm.Applications.TableHeader.CommentTooltip'" />
          </th>
          <th style="width: 20%">
            <span translate="Portal.ViewPlanningRealm.Applications.TableHeader.Notes"></span>
            <tp-tooltip-icon [tooltipText]="'Portal.ViewPlanningRealm.Applications.TableHeader.NotesTooltip'" />
          </th>
          <th style="width: 1px"></th>
        </tr>
      </thead>
      <tbody>
        @for (application of result.items; track application; let i = $index) {
          @let showApplicationTeams = expandedApplications[application.id];
          @let visibleTeamsCount = getNumberOfVisibleTeams(application);
          @let hiddenTeamsCount = getNumberOfHiddenTeams(application);

          <tr style="height: 48px">
            <!-- height is set to 48px to prevent "jumping" when expanding/collapsing the teams list -->
            <td class="text-center" [rowSpan]="showApplicationTeams ? 2 : 1">
              <tp-action-button
                [mode]="'IconOnly'"
                [icon]="showApplicationTeams ? 'chevron-bar-contract' : 'chevron-bar-expand'"
                [type]="'outline-secondary'"
                (buttonClick)="setApplicationExpanded(application.id, !showApplicationTeams)" />
            </td>
            <td class="text-center align-correctly">{{ result.currentPage * result.itemsPerPage + i + 1 }}</td>
            <td class="text-center align-correctly">
              @if (application.sourceLinkId) {
                @let invitationLink = getInvitationLink(application.sourceLinkId);
                @if (invitationLink) {
                  <span
                    class="d-inline-block text-center text-white"
                    style="width: 1.5em; border-radius: 0.4em"
                    [ngStyle]="{ 'background-color': '#' + invitationLink.colorCode }"
                    [ngbTooltip]="'Portal.ViewPlanningRealm.Applications.SourceLinkTooltip' | translate: { name: invitationLink.name }">
                    <i class="bi bi-link-45deg"></i
                  ></span>
                }
              } @else {
                <tp-tooltip-icon
                  [margin]="false"
                  [icon]="'vector-pen'"
                  [iconClass]="'text-secondary'"
                  [tooltipText]="'Portal.ViewPlanningRealm.Applications.NoSourceLinkTooltip'" />
              }
            </td>
            <td class="text-nowrap align-correctly">
              <span class="me-2">{{ application.tag }}</span>
              <tp-copy-to-clipboard [value]="application.tag" />
            </td>
            <td class="text-nowrap align-correctly">{{ application.createdAt | translateDate: 'short' }}</td>
            <td class="align-correctly">
              @if (application.teams.length === 0) {
                <span class="fw-bold text-warning">0</span>
              } @else {
                <span>{{ visibleTeamsCount }}</span>
                @if (visibleTeamsCount !== application.teams.length) {
                  <tp-tooltip-icon
                    [icon]="'exclamation-diamond'"
                    [tooltipText]="'Portal.ViewPlanningRealm.Applications.HiddenTeamsTooltip'" />
                }
              }
            </td>
            <td class="align-correctly">{{ application.contact }}</td>
            <td class="align-correctly">
              @if (application.contactEmail) {
                <a href="mailto:{{ application.contactEmail }}" class="me-2">{{ application.contactEmail }}</a>
                <tp-copy-to-clipboard [value]="application.contactEmail" />
              }
            </td>
            <td class="align-correctly">{{ application.contactTelephone ?? '' }}</td>
            <td class="align-correctly">{{ application.comment ?? '' }}</td>
            <td class="align-correctly">
              @if (application.notes.length > 0) {
                <div style="white-space: preserve" class="mb-1">{{ application.notes }}</div>
              }
              <div>
                @if (updatingNotesOfApplicationId === application.id) {
                  <tp-small-spinner />
                } @else if (writeAllowed) {
                  @let isCurrentlyUpdating = updatingNotesOfApplicationId !== undefined;
                  <i
                    class="bi bi-pencil"
                    [ngClass]="{ 'tp-cursor-not-allowed': isCurrentlyUpdating, 'tp-cursor-pointer': !isCurrentlyUpdating }"
                    [ngbTooltip]="isCurrentlyUpdating ? undefined : ('Portal.ViewPlanningRealm.Applications.EditNotes.Title' | translate)"
                    (click)="editApplicationNotes(application)"></i>
                }
              </div>
            </td>
            <td class="align-correctly">
              <i
                class="bi bi-clock-history tp-cursor-pointer"
                [ngbTooltip]="'Portal.ViewPlanningRealm.Applications.ChangeLogTooltip' | translate"
                (click)="showApplicationChangeLog(application)"></i>
            </td>
          </tr>

          @if (showApplicationTeams) {
            <tr>
              <td colspan="11">
                <table style="max-width: 900px" class="mb-2 table table-sm table-bordered">
                  <thead>
                    <tr>
                      <th translate="Portal.ViewPlanningRealm.Applications.TableHeader.TournamentClass"></th>
                      <th translate="Portal.ViewPlanningRealm.Applications.TableHeader.TeamName"></th>
                      <th translate="Portal.ViewPlanningRealm.Applications.TableHeader.Labels"></th>
                      <th translate="Portal.ViewPlanningRealm.Applications.TableHeader.Tournament"></th>
                      <th style="width: 1px"></th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (team of application.teams; track team) {
                      @if (isTeamVisible(team)) {
                        <tr>
                          <td class="align-middle">{{ getTournamentClassName(team.tournamentClassId) }}</td>
                          <td class="align-middle">
                            <span>{{ team.name }}</span>
                            @if (writeAllowed) {
                              <tp-rename-button
                                class="ms-2"
                                translationKey="Portal.ViewPlanningRealm.Applications.RenameTeam"
                                [current]="team.name"
                                [displayLabel]="false"
                                [reducedFootprint]="true"
                                (renamed)="renameTeam(application.id, team, $event)" />
                            }
                          </td>
                          <td class="align-middle">
                            @for (labelId of team.labelIds; track labelId; let isFirst = $first) {
                              <tp-label [class]="{ 'ms-1': !isFirst }" [label]="getLabel(labelId)" />
                            } @empty {
                              <span
                                class="fst-italic small text-secondary text-nowrap"
                                [translate]="'Portal.ViewPlanningRealm.Applications.NoLabels'"></span>
                            }
                            @if (updatingLabelsOfApplicationTeamId === team.id) {
                              <tp-small-spinner class="ms-2" />
                            } @else if (writeAllowed) {
                              <i class="bi bi-pencil tp-cursor-pointer ms-2" (click)="editTeamLabels(application.id, team)"></i>
                            }
                          </td>
                          <td class="align-middle">
                            @if (team.linkedTournament) {
                              <div class="d-flex flex-row align-items-center gap-2">
                                <span>{{ team.linkedTournament.name }}</span>
                                <span class="small text-secondary">{{ team.linkedTournament.folderName }}</span>
                                <tp-action-button
                                  [icon]="'box-arrow-up-right'"
                                  [mode]="'IconOnly'"
                                  [type]="'outline-secondary'"
                                  (buttonClick)="navigateToTournament(team.linkedTournament.id)" />
                              </div>
                            } @else {
                              <span
                                class="fst-italic small text-secondary"
                                translate="Portal.ViewPlanningRealm.Applications.NoLinkedTournament"></span>
                            }
                          </td>
                          <td class="align-middle px-2">
                            @if (team.linkedTournament) {
                              <tp-tooltip-icon
                                [margin]="false"
                                [tooltipText]="'Portal.ViewPlanningRealm.Applications.CannotDeleteTeamWhileLinked'" />
                            } @else {
                              <tp-delete-button [reducedFootprint]="true" (confirmed)="deleteTeam(application.id, team.id)" />
                            }
                          </td>
                        </tr>
                      }
                    } @empty {
                      <tr>
                        <td colspan="5">
                          <span class="fst-italic small text-secondary" translate="Portal.ViewPlanningRealm.Applications.NoTeams"></span>
                        </td>
                      </tr>
                    }

                    @if (hiddenTeamsCount > 0) {
                      <tr>
                        <td colspan="5">
                          <span
                            class="fst-italic small text-secondary"
                            translate="Portal.ViewPlanningRealm.Applications.HiddenTeams"
                            [translateParams]="{ count: hiddenTeamsCount }"></span>
                          <span
                            class="ms-2 small text-secondary text-decoration-underline tp-cursor-pointer"
                            translate="Portal.ViewPlanningRealm.Applications.HiddenTeamsShowAll"
                            (click)="setFilterToApplicationTag(application.tag)"></span>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>

                <tp-action-button
                  [icon]="'plus-circle'"
                  [type]="'outline-secondary'"
                  [title]="'Portal.ViewPlanningRealm.Applications.AddTeam.Button'"
                  (buttonClick)="addTeam(application.id)" />
              </td>
            </tr>
          }
        }
      </tbody>
    </table>

    <tp-pagination [pagination]="result" (pageChange)="switchPage($event)" />
  }
}
